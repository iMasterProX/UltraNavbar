package com.minsoo.ultranavbar.ui

import android.content.res.Configuration
import android.graphics.Color
import android.os.Bundle
import android.view.View
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.card.MaterialCardView
import com.minsoo.ultranavbar.R
import com.minsoo.ultranavbar.ui.view.DrawingCanvasView

/**
 * 펜 버튼 기능 테스트를 위한 캔버스 Activity
 *
 * 사용자가 펜 버튼 A/B에 설정한 기능이 실제로 작동하는지 테스트할 수 있습니다.
 */
class PenTestCanvasActivity : AppCompatActivity() {

    private lateinit var canvasView: DrawingCanvasView
    private var isEraserMode = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_pen_test_canvas)

        supportActionBar?.setDisplayHomeAsUpEnabled(true)
        title = getString(R.string.pen_test_canvas_title)

        canvasView = findViewById(R.id.drawingCanvas)

        // 다크 모드 확인하여 색상 설정
        val isDarkMode = (resources.configuration.uiMode and Configuration.UI_MODE_NIGHT_MASK) == Configuration.UI_MODE_NIGHT_YES
        val drawColor = if (isDarkMode) Color.WHITE else Color.BLACK
        canvasView.setPaintColor(drawColor)

        setupButtons()
        showInstructions()
    }

    private fun setupButtons() {
        findViewById<MaterialButton>(R.id.btnUndo)?.setOnClickListener {
            canvasView.undo()
        }

        findViewById<MaterialButton>(R.id.btnRedo)?.setOnClickListener {
            canvasView.redo()
        }

        findViewById<MaterialButton>(R.id.btnEraser)?.setOnClickListener {
            toggleEraser()
        }

        findViewById<MaterialButton>(R.id.btnClear)?.setOnClickListener {
            canvasView.clear()
        }

        findViewById<MaterialButton>(R.id.btnBrushUp)?.setOnClickListener {
            canvasView.increaseBrushSize()
            showBrushSize()
        }

        findViewById<MaterialButton>(R.id.btnBrushDown)?.setOnClickListener {
            canvasView.decreaseBrushSize()
            showBrushSize()
        }
    }

    private fun toggleEraser() {
        isEraserMode = !isEraserMode
        canvasView.setEraserMode(isEraserMode)

        val btn = findViewById<MaterialButton>(R.id.btnEraser)
        if (isEraserMode) {
            btn?.text = getString(R.string.pen_test_brush_mode)
            btn?.setIconResource(R.drawable.ic_brush)
        } else {
            btn?.text = getString(R.string.pen_test_eraser_mode)
            btn?.setIconResource(R.drawable.ic_eraser)
        }
    }

    private fun showBrushSize() {
        val size = canvasView.getCurrentBrushSize()
        Toast.makeText(this, getString(R.string.pen_test_brush_size, size), Toast.LENGTH_SHORT).show()
    }

    private fun showInstructions() {
        val card = findViewById<MaterialCardView>(R.id.cardInstructions)
        val btnDismiss = findViewById<MaterialButton>(R.id.btnDismissInstructions)

        btnDismiss?.setOnClickListener {
            card?.visibility = View.GONE
        }
    }

    override fun onSupportNavigateUp(): Boolean {
        finish()
        return true
    }

    // 외부에서 Undo/Redo/Eraser 기능 호출 (펜 버튼 이벤트용)
    fun performUndo() {
        runOnUiThread {
            canvasView.undo()
        }
    }

    fun performRedo() {
        runOnUiThread {
            canvasView.redo()
        }
    }

    fun performEraserToggle() {
        runOnUiThread {
            toggleEraser()
        }
    }

    fun performBrushSizeIncrease() {
        runOnUiThread {
            canvasView.increaseBrushSize()
            showBrushSize()
        }
    }

    fun performBrushSizeDecrease() {
        runOnUiThread {
            canvasView.decreaseBrushSize()
            showBrushSize()
        }
    }
}
